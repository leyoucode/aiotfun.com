---
import { getLocaleFromUrl, useTranslations, getLanguageSwitchUrl, localePath } from '../utils/i18n';

const locale = getLocaleFromUrl(Astro.url);
const t = useTranslations(locale);
const switchUrl = getLanguageSwitchUrl(Astro.url);
const currentPath = Astro.url.pathname;

const navItems = [
  { key: 'products', href: localePath('/products/', locale) },
  { key: 'boards', href: localePath('/boards/', locale) },
  { key: 'builds', href: localePath('/builds/', locale) },
  { key: 'models', href: localePath('/models/', locale) },
  { key: 'signals', href: localePath('/signals/', locale) },
  { key: 'about', href: localePath('/about/', locale) },
] as const;
---

<header class="sticky top-0 z-50 border-b border-border bg-bg/95 backdrop-blur-md">
  <div class="mx-auto flex h-16 max-w-content items-center justify-between px-4 md:px-6">
    <!-- Logo -->
    <a href={localePath('/', locale)} class="flex items-center gap-2 font-body text-xl font-bold tracking-tight">
      <img src="/logo.png" alt="AIoTFun" class="h-8 w-8" />
      <span><span class="text-text">AIoT</span><span class="text-accent">Fun</span></span>
    </a>

    <!-- 桌面端导航 -->
    <nav class="hidden items-center gap-4 lg:flex lg:gap-6">
      {navItems.map((item) => {
        const label = t.nav[item.key];
        const isActive = currentPath.startsWith(item.href.replace(/\/$/, ''));
        return (
          <a
            href={item.href}
            class:list={[
              'font-body text-sm transition-colors hover:text-accent',
              isActive ? 'font-semibold text-accent' : 'text-text-muted',
            ]}
          >
            {label}
          </a>
        );
      })}
    </nav>

    <!-- 右侧：语言切换 + 移动端汉堡 -->
    <div class="flex items-center gap-4">
      <a
        href={switchUrl}
        class="font-body text-xs text-text-muted transition-colors hover:text-accent"
      >
        {t.common.lang_switch}
      </a>

      <!-- Search button -->
      <button id="search-btn" class="flex h-8 w-8 items-center justify-center rounded-full text-text-muted hover:text-accent transition-colors" aria-label="Search" title="⌘K">
        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
        </svg>
      </button>

      <!-- Theme toggle -->
      <button id="theme-toggle" class="flex h-8 w-8 items-center justify-center rounded-full text-text-muted hover:text-accent transition-colors" aria-label="Toggle dark mode">
        <svg id="theme-sun" class="hidden h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
        </svg>
        <svg id="theme-moon" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
        </svg>
      </button>

      <!-- 汉堡菜单按钮 -->
      <button
        id="mobile-menu-btn"
        class="flex flex-col gap-1.5 lg:hidden"
        aria-label="Toggle menu"
      >
        <span class="hamburger-line block h-0.5 w-5 bg-text transition-transform"></span>
        <span class="hamburger-line block h-0.5 w-5 bg-text transition-opacity"></span>
        <span class="hamburger-line block h-0.5 w-5 bg-text transition-transform"></span>
      </button>
    </div>
  </div>

  <!-- 移动端菜单 -->
  <nav
    id="mobile-menu"
    class="hidden border-t border-border bg-bg px-4 pb-4 pt-2 lg:hidden"
  >
    {navItems.map((item) => {
      const label = t.nav[item.key];
      const isActive = currentPath.startsWith(item.href.replace(/\/$/, ''));
      return (
        <a
          href={item.href}
          class:list={[
            'block py-2 font-body text-sm transition-colors hover:text-accent',
            isActive ? 'font-semibold text-accent' : 'text-text-muted',
          ]}
        >
          {label}
        </a>
      );
    })}
  </nav>
</header>

<script>
  document.addEventListener('astro:page-load', () => {
    const btn = document.getElementById('mobile-menu-btn');
    if (!btn || btn.dataset.init) return;
    btn.dataset.init = 'true';

    const menu = document.getElementById('mobile-menu');
    const lines = btn.querySelectorAll('.hamburger-line');

    btn.addEventListener('click', () => {
      const isOpen = !menu?.classList.contains('hidden');
      menu?.classList.toggle('hidden');
      document.body.style.overflow = isOpen ? '' : 'hidden';

      if (lines && lines.length === 3) {
        if (isOpen) {
          (lines[0] as HTMLElement).style.transform = '';
          (lines[1] as HTMLElement).style.opacity = '1';
          (lines[2] as HTMLElement).style.transform = '';
        } else {
          (lines[0] as HTMLElement).style.transform = 'translateY(4px) rotate(45deg)';
          (lines[1] as HTMLElement).style.opacity = '0';
          (lines[2] as HTMLElement).style.transform = 'translateY(-4px) rotate(-45deg)';
        }
      }
    });

    window.addEventListener('resize', () => {
      if (window.innerWidth >= 1024) {
        menu?.classList.add('hidden');
        document.body.style.overflow = '';
        if (lines && lines.length === 3) {
          (lines[0] as HTMLElement).style.transform = '';
          (lines[1] as HTMLElement).style.opacity = '1';
          (lines[2] as HTMLElement).style.transform = '';
        }
      }
    });

    // Search button
    const searchBtn = document.getElementById('search-btn');
    searchBtn?.addEventListener('click', () => {
      (window as any).__openSearch?.();
    });

    // Theme toggle
    const themeToggle = document.getElementById('theme-toggle');
    const sunIcon = document.getElementById('theme-sun');
    const moonIcon = document.getElementById('theme-moon');

    function updateIcons() {
      const isDark = document.documentElement.classList.contains('dark');
      sunIcon?.classList.toggle('hidden', !isDark);
      moonIcon?.classList.toggle('hidden', isDark);
    }
    updateIcons();

    themeToggle?.addEventListener('click', () => {
      const isDark = document.documentElement.classList.toggle('dark');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      updateIcons();
      const f = document.querySelector<HTMLIFrameElement>('iframe.giscus-frame');
      f?.contentWindow?.postMessage(
        { giscus: { setConfig: { theme: isDark ? 'dark' : 'light' } } },
        'https://giscus.app'
      );
    });
  });
</script>
