---
import ArticleCard from './ArticleCard.astro';
import { getLocaleFromUrl, useTranslations } from '../utils/i18n';
import { getFeaturedArticles, getLatestArticles } from '../utils/articles';

const locale = getLocaleFromUrl(Astro.url);
const t = useTranslations(locale);
const featured = await getFeaturedArticles(locale);
const latest = await getLatestArticles(locale, 6);
const sideArticles = latest.filter((a) => !a.featured).slice(0, 3);
const heroArticles = [featured[0], ...sideArticles].filter(Boolean);
---

<section class="mx-auto max-w-content px-4 py-8 md:px-6 md:py-12">
  <!-- 大标题 -->
  <h1 class="mb-8 text-center font-body text-3xl font-bold md:text-4xl lg:text-5xl">
    {t.home.hero_title}
  </h1>

  <!-- ViewPager 轮播 -->
  <div class="hero-pager relative overflow-hidden rounded-card">
    <!-- 滑动轨道 -->
    <div class="hero-track flex">
      {heroArticles.map((article) => (
        <div class="w-full flex-shrink-0">
          <ArticleCard article={article} variant="featured" />
        </div>
      ))}
    </div>

    <!-- 指示圆点 -->
    <div class="absolute bottom-4 right-4 flex gap-2 z-10">
      {heroArticles.map((_, i) => (
        <button
          class:list={[
            'hero-dot h-2.5 w-2.5 rounded-full border border-white/30 transition-all duration-300',
            i === 0 ? 'bg-white scale-110' : 'bg-white/40',
          ]}
          data-index={i}
          aria-label={`Slide ${i + 1}`}
        />
      ))}
    </div>
  </div>
</section>

<script>
  document.querySelectorAll('.hero-pager').forEach((pager) => {
    const track = pager.querySelector('.hero-track') as HTMLElement;
    const dots = pager.querySelectorAll('.hero-dot') as NodeListOf<HTMLElement>;
    const total = dots.length;
    let current = 0;
    let startX = 0;
    let deltaX = 0;
    let dragging = false;
    let wasDrag = false;
    let pagerWidth = 0;

    function goTo(index: number) {
      current = Math.max(0, Math.min(index, total - 1));
      track.style.transition = 'transform 0.35s cubic-bezier(.4,0,.2,1)';
      track.style.transform = `translateX(-${current * 100}%)`;
      dots.forEach((d, i) => {
        if (i === current) {
          d.className = 'hero-dot h-2.5 w-2.5 rounded-full border border-white/30 transition-all duration-300 bg-white scale-110';
        } else {
          d.className = 'hero-dot h-2.5 w-2.5 rounded-full border border-white/30 transition-all duration-300 bg-white/40';
        }
      });
    }

    // 圆点点击
    dots.forEach((dot, i) => {
      dot.addEventListener('click', () => goTo(i));
    });

    // 拖拽开始
    function onStart(x: number) {
      dragging = true;
      wasDrag = false;
      startX = x;
      deltaX = 0;
      pagerWidth = (pager as HTMLElement).clientWidth;
      track.style.transition = 'none';
    }

    // 拖拽移动
    function onMove(x: number) {
      if (!dragging) return;
      deltaX = x - startX;
      if (Math.abs(deltaX) > 5) wasDrag = true;
      const offset = -current * pagerWidth + deltaX;
      track.style.transform = `translateX(${offset}px)`;
    }

    // 拖拽结束
    function onEnd() {
      if (!dragging) return;
      dragging = false;
      const threshold = pagerWidth * 0.15;
      if (deltaX < -threshold && current < total - 1) {
        goTo(current + 1);
      } else if (deltaX > threshold && current > 0) {
        goTo(current - 1);
      } else {
        goTo(current);
      }
    }

    // 阻止拖拽后触发链接点击
    pager.addEventListener('click', (e) => {
      if (wasDrag) {
        e.preventDefault();
        e.stopPropagation();
        wasDrag = false;
      }
    }, true);

    // 鼠标事件
    pager.addEventListener('mousedown', (e) => {
      e.preventDefault();
      onStart((e as MouseEvent).pageX);
    });
    window.addEventListener('mousemove', (e) => onMove(e.pageX));
    window.addEventListener('mouseup', onEnd);

    // 触摸事件
    pager.addEventListener('touchstart', (e) => {
      onStart((e as TouchEvent).touches[0].pageX);
    }, { passive: true });
    pager.addEventListener('touchmove', (e) => {
      onMove((e as TouchEvent).touches[0].pageX);
    }, { passive: true });
    pager.addEventListener('touchend', onEnd);
  });
</script>

<style>
  .hero-pager {
    cursor: grab;
    user-select: none;
    touch-action: pan-y;
  }
  .hero-pager:active {
    cursor: grabbing;
  }
</style>
