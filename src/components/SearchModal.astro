<!-- Search Modal: full-screen overlay with PagefindUI -->
<div id="search-modal" class="fixed inset-0 z-[70] hidden">
  <!-- Backdrop -->
  <div id="search-backdrop" class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>

  <!-- Modal card -->
  <div class="relative mx-auto mt-[10vh] w-[90vw] max-w-2xl rounded-card border border-border bg-card-bg shadow-card">
    <!-- Header -->
    <div class="flex items-center justify-between border-b border-border px-5 py-3">
      <span class="font-body text-sm font-semibold text-text" id="search-title">Search</span>
      <button id="search-close" class="flex items-center gap-1 text-text-muted hover:text-text transition-colors">
        <kbd class="rounded border border-border bg-bg px-1.5 py-0.5 font-mono text-xs">ESC</kbd>
      </button>
    </div>

    <!-- PagefindUI mount point -->
    <div id="pagefind-container" class="max-h-[60vh] overflow-y-auto px-5 py-4"></div>
  </div>
</div>

<script is:inline>
  (function() {
    if (window.__searchInit) return;
    window.__searchInit = true;

    var pagefindLoaded = false;
    var currentLang = '';

    function getTranslations(lang) {
      if (lang === 'zh') {
        return {
          title: '搜索',
          placeholder: '搜索文章...',
          clear_search: '清除',
          load_more: '加载更多',
          search_label: '搜索本站',
          filters_label: '筛选',
          zero_results: '没有找到 [SEARCH_TERM] 的相关结果',
          many_results: '找到 [COUNT] 条 [SEARCH_TERM] 的相关结果',
          one_result: '找到 1 条 [SEARCH_TERM] 的相关结果',
          alt_search: '没有找到 [SEARCH_TERM] 的结果，显示 [DIFFERENT_TERM] 的结果',
          search_suggestion: '没有找到 [SEARCH_TERM] 的结果，试试以下搜索：',
        };
      }
      return { title: 'Search', placeholder: 'Search articles...' };
    }

    async function initPagefind() {
      var container = document.getElementById('pagefind-container');
      var titleEl = document.getElementById('search-title');
      if (container) container.innerHTML = '';
      currentLang = document.documentElement.lang || 'en';
      var tr = getTranslations(currentLang);
      if (titleEl) titleEl.textContent = tr.title;

      try {
        var mod = await import('/pagefind/pagefind-ui.js');
        var PagefindUI = mod.PagefindUI || mod.default;
        new PagefindUI({
          element: '#pagefind-container',
          showSubResults: true,
          showImages: false,
          translations: tr,
          autofocus: true,
        });
        pagefindLoaded = true;
      } catch(e) {
        if (container) container.innerHTML = '<p class="text-text-muted text-sm">Search index not available. Run <code>pnpm build</code> first.</p>';
      }
    }

    function openSearch() {
      var modal = document.getElementById('search-modal');
      if (!modal) return;
      var lang = document.documentElement.lang || 'en';
      if (!pagefindLoaded || lang !== currentLang) {
        initPagefind();
      }
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      setTimeout(function() {
        var container = document.getElementById('pagefind-container');
        var input = container && container.querySelector('.pagefind-ui__search-input');
        if (input) input.focus();
      }, 100);
    }

    function closeSearch() {
      var modal = document.getElementById('search-modal');
      if (!modal) return;
      modal.classList.add('hidden');
      document.body.style.overflow = '';
    }

    window.__openSearch = openSearch;
    window.__closeSearch = closeSearch;

    document.getElementById('search-backdrop').addEventListener('click', closeSearch);
    document.getElementById('search-close').addEventListener('click', closeSearch);
    document.addEventListener('keydown', function(e) {
      var modal = document.getElementById('search-modal');
      if (e.key === 'Escape' && modal && !modal.classList.contains('hidden')) {
        closeSearch();
      }
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        if (modal && modal.classList.contains('hidden')) {
          openSearch();
        } else {
          closeSearch();
        }
      }
    });
  })();
</script>

<style is:global>
  /* PagefindUI style overrides */
  :root {
    --pagefind-ui-primary: #10B981;
    --pagefind-ui-text: rgb(var(--color-text));
    --pagefind-ui-background: rgb(var(--color-card-bg));
    --pagefind-ui-border: rgb(var(--color-border));
    --pagefind-ui-tag: rgb(var(--color-bg-alt));
    --pagefind-ui-border-width: 1px;
    --pagefind-ui-border-radius: 6px;
    --pagefind-ui-image-border-radius: 6px;
    --pagefind-ui-image-box-ratio: 2 / 1;
    --pagefind-ui-font: 'Inter', 'Noto Sans SC', sans-serif;
  }

  .pagefind-ui__search-input {
    font-weight: 400 !important;
    background: rgb(var(--color-bg)) !important;
  }

  .pagefind-ui__search-input:focus {
    outline: none !important;
    box-shadow: 0 0 0 2px #10B981 !important;
    border-color: #10B981 !important;
  }

  .pagefind-ui__result-link {
    color: rgb(var(--color-text)) !important;
    font-weight: 600 !important;
  }

  .pagefind-ui__result-link:hover {
    color: #10B981 !important;
  }

  .pagefind-ui__result-excerpt {
    color: rgb(var(--color-text-muted)) !important;
  }

  .pagefind-ui__message {
    color: rgb(var(--color-text-muted)) !important;
  }

  .pagefind-ui__button {
    background: rgb(var(--color-bg-alt)) !important;
    color: rgb(var(--color-text)) !important;
    border: 1px solid rgb(var(--color-border)) !important;
  }

  .pagefind-ui__button:hover {
    border-color: #10B981 !important;
    color: #10B981 !important;
  }

  /* Hide powered-by */
  .pagefind-ui__footer {
    display: none !important;
  }
</style>
