---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import ArticleCard from '../../../components/ArticleCard.astro';
import { getArticlesByCategory, getAllCategories } from '../../../utils/articles';
import { useTranslations, localePath } from '../../../utils/i18n';
import type { GetStaticPaths } from 'astro';

export const getStaticPaths: GetStaticPaths = () => {
  return getAllCategories().map((cat) => ({
    params: { category: cat },
  }));
};

const locale = 'zh';
const { category } = Astro.params;
const t = useTranslations(locale);
const articles = await getArticlesByCategory(category!, locale);
const categoryLabel = t.category[category as keyof typeof t.category] || category;
const description = (t as any).category_page.descriptions[category as string] || '';
const cp = (t as any).category_page;

// 收集该分类下的所有 formatTag
const formatTags = [...new Set(articles.map((a) => a.formatTag))];
---

<BaseLayout title={`${categoryLabel} — AIoTFun`} description={description}>
  <div class="mx-auto max-w-content px-4 md:px-6 py-8">
    <!-- 分类标题 -->
    <div class="mb-8">
      <h1 class="font-display text-3xl md:text-4xl font-bold text-text mb-3">
        {categoryLabel}
      </h1>
      <p class="text-text-muted text-lg max-w-2xl">{description}</p>
      <p class="mt-2 font-mono text-sm text-text-muted" id="article-count">
        {cp.article_count.replace('{count}', String(articles.length))}
      </p>
    </div>

    <!-- 筛选栏 -->
    {formatTags.length > 1 && (
      <div class="mb-8 flex flex-wrap gap-2" id="format-filter">
        <button
          class="filter-btn active rounded-full border border-accent bg-accent/10 px-4 py-1.5 text-sm font-body text-accent transition-colors"
          data-format="all"
        >
          {cp.all}
        </button>
        {formatTags.map((tag) => (
          <button
            class="filter-btn rounded-full border border-border px-4 py-1.5 text-sm font-body text-text-muted hover:border-accent hover:text-accent transition-colors"
            data-format={tag}
          >
            {t.format[tag as keyof typeof t.format] || tag}
          </button>
        ))}
      </div>
    )}

    <!-- 文章网格 -->
    {articles.length > 0 ? (
      <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3" id="articles-grid">
        {articles.map((article) => (
          <div class="article-item" data-format={article.formatTag}>
            <ArticleCard article={article} variant="medium" />
          </div>
        ))}
      </div>
    ) : (
      <div class="text-center py-16">
        <p class="text-text-muted text-lg">{cp.no_articles}</p>
      </div>
    )}

    <!-- 空状态（筛选后无结果） -->
    <div class="hidden text-center py-16" id="empty-state">
      <p class="text-text-muted text-lg">{cp.no_articles}</p>
    </div>

    <!-- 分页导航 -->
    <nav class="mt-10 flex items-center justify-center gap-2" id="pagination" aria-label="Pagination">
    </nav>
  </div>
</BaseLayout>

<script define:vars={{ perPage: 12, i18n: { showing: cp.showing_count, prev: cp.prev, next: cp.next, pageOf: cp.page_of, articleCount: cp.article_count } }}>
  const allItems = Array.from(document.querySelectorAll('.article-item'));
  const grid = document.getElementById('articles-grid');
  const pagination = document.getElementById('pagination');
  const countEl = document.getElementById('article-count');
  const emptyState = document.getElementById('empty-state');
  const buttons = document.querySelectorAll('.filter-btn');

  let currentFormat = 'all';
  let currentPage = 1;

  function getFilteredItems() {
    if (currentFormat === 'all') return allItems;
    return allItems.filter((el) => el.dataset.format === currentFormat);
  }

  function render() {
    const filtered = getFilteredItems();
    const total = filtered.length;
    const totalPages = Math.max(1, Math.ceil(total / perPage));

    // 修正当前页
    if (currentPage > totalPages) currentPage = totalPages;

    const start = (currentPage - 1) * perPage;
    const end = Math.min(start + perPage, total);

    // 显隐文章
    const visible = new Set(filtered.slice(start, end));
    allItems.forEach((item) => {
      item.style.display = visible.has(item) ? '' : 'none';
    });

    // 更新计数
    if (countEl) {
      if (total === allItems.length) {
        countEl.textContent = i18n.articleCount.replace('{count}', String(total));
      } else {
        countEl.textContent = i18n.showing
          .replace('{from}', String(start + 1))
          .replace('{to}', String(end))
          .replace('{total}', String(total));
      }
    }

    // 空状态
    if (grid) grid.style.display = total === 0 ? 'none' : '';
    if (emptyState) emptyState.classList.toggle('hidden', total > 0);

    // 渲染分页
    renderPagination(totalPages, total);
  }

  function renderPagination(totalPages, total) {
    if (!pagination) return;

    // 不需要分页时隐藏
    if (totalPages <= 1) {
      pagination.innerHTML = '';
      return;
    }

    let html = '';

    // 上一页
    html += `<button class="page-btn rounded-lg border border-border px-3 py-1.5 text-sm font-body text-text-muted hover:border-accent hover:text-accent transition-colors ${currentPage === 1 ? 'opacity-40 pointer-events-none' : ''}" data-page="${currentPage - 1}">${i18n.prev}</button>`;

    // 页码
    const pages = getPageNumbers(currentPage, totalPages);
    pages.forEach((p) => {
      if (p === '...') {
        html += `<span class="px-1 text-text-muted">…</span>`;
      } else {
        const isActive = p === currentPage;
        html += `<button class="page-btn rounded-lg border ${isActive ? 'border-accent bg-accent/10 text-accent' : 'border-border text-text-muted hover:border-accent hover:text-accent'} w-9 h-9 text-sm font-body transition-colors" data-page="${p}">${p}</button>`;
      }
    });

    // 下一页
    html += `<button class="page-btn rounded-lg border border-border px-3 py-1.5 text-sm font-body text-text-muted hover:border-accent hover:text-accent transition-colors ${currentPage === totalPages ? 'opacity-40 pointer-events-none' : ''}" data-page="${currentPage + 1}">${i18n.next}</button>`;

    pagination.innerHTML = html;

    // 绑定页码点击
    pagination.querySelectorAll('.page-btn').forEach((btn) => {
      btn.addEventListener('click', () => {
        const page = parseInt(btn.dataset.page || '1');
        if (page >= 1 && page <= totalPages) {
          currentPage = page;
          render();
          // 滚动到网格顶部
          grid?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    });
  }

  // 生成页码数组（含省略号）
  function getPageNumbers(current, total) {
    if (total <= 7) return Array.from({ length: total }, (_, i) => i + 1);

    const pages = [];
    pages.push(1);

    if (current > 3) pages.push('...');

    const rangeStart = Math.max(2, current - 1);
    const rangeEnd = Math.min(total - 1, current + 1);

    for (let i = rangeStart; i <= rangeEnd; i++) {
      pages.push(i);
    }

    if (current < total - 2) pages.push('...');

    pages.push(total);
    return pages;
  }

  // 筛选按钮事件
  buttons.forEach((btn) => {
    btn.addEventListener('click', () => {
      currentFormat = btn.dataset.format || 'all';
      currentPage = 1;

      // 更新按钮样式
      buttons.forEach((b) => {
        b.classList.remove('active', 'border-accent', 'bg-accent/10', 'text-accent');
        b.classList.add('border-border', 'text-text-muted');
      });
      btn.classList.add('active', 'border-accent', 'bg-accent/10', 'text-accent');
      btn.classList.remove('border-border', 'text-text-muted');

      render();
    });
  });

  // 初始渲染
  render();
</script>
